<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
  <!--<![endif]-->
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title></title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <h1 id="winner-header">fdsfs</h1>
    <div class="game-container">
      <div class="cell-container">
        <div data-value="0" id="cell-0" class="cell"></div>
        <div data-value="1" id="cell-1" class="cell"></div>
        <div data-value="2" id="cell-2" class="cell"></div>
        <div data-value="3" id="cell-3" class="cell"></div>
        <div data-value="4" id="cell-4" class="cell"></div>
        <div data-value="5" id="cell-5" class="cell"></div>
        <div data-value="6" id="cell-6" class="cell"></div>
        <div data-value="7" id="cell-7" class="cell"></div>
        <div data-value="8" id="cell-8" class="cell"></div>
      </div>
    </div>
    <div>
      <button id="new-game-btn">New Game</button>
    </div>

    <script src="./main.js"></script>
    <script>
      let symbol = {
        0: "",
        1: "X",
        2: "O"
      };

      let cellClickHandler = e => {
        Module.make_player_move(parseInt(e.target.getAttribute("data-value")));
        updateBoard();
        Module.make_ai_move();
        updateBoard();
      };

      let makeUnclickable = elem => {
        elem.classList.remove("empty-cell");
        elem.removeEventListener("click", cellClickHandler);
      };

      let gameEnded = () => {
        // make everything unclickable
        document.querySelectorAll(".empty-cell").forEach(makeUnclickable);

        // change winner header
        let winner = Module.get_winner();
        let title;
        if (winner === 0) {
          title = "Tie Game!";
        } else if (winner == 1) {
          title == "X Wins!";
        } else {
          title = "O Wins!";
        }
        document.querySelector("#winner-header").innerHTML = title;
      };

      let updateBoard = () => {
        let board = Module.get_gameboard();
        for (let i = 0; i < 9; i++) {
          let elem = document.querySelector(`#cell-${i}`);
          elem.innerHTML = symbol[board[i]];
          if (board[i] !== 0) {
            makeUnclickable(elem);
          }
        }

        if (Module.has_game_ended()) {
          gameEnded();
        }
      };

      startNewGame = () => {
        document.querySelector("#winner-header").innerHTML = "";
        Module.start_new_game();

        // reset
        document.querySelectorAll(".cell").forEach(elem => {
          elem.classList.add("empty-cell");
          elem.addEventListener("click", cellClickHandler);
        });

        updateBoard();
      };

      Module.onRuntimeInitialized = () => {
        // new game btn listener
        document
          .querySelector("#new-game-btn")
          .addEventListener("click", startNewGame);

        // update the board
        startNewGame();
      };
    </script>
  </body>
</html>
